Dado el modelo relacional:
\begin{center}
	\begin{tabular}{l}
		$Persona(\underline{dni}, sexo, edad)$\\
		$Habla(\underline{dniPersona}, \underline{idioma}, grado)$\\
		$SolicitaCita(\underline{dniSolicitante}, \underline{dniSolicitado}, idioma)$\\	
	\end{tabular}
\end{center}

\begin{enumerate}
	
	% a)
	\item 
	\begin{lstlisting}[language=sql]
	select idioma, count(*) as no_hablantes
	from Habla
	where grado = 3
	group by idioma
	order by no_hablantes desc;\end{lstlisting}
	
	% b)
	\item 
	\begin{lstlisting}[language=sql]
	select avg(edad) as promedio_edad_hispanohablantes
	from Habla h1
		 inner join Persona on h1.dniPersona = dni
	where idioma = `Espanol' and idioma not in (
			select idioma
			from Habla h2
			where h1.dniPersona = h2.dniPersona and h2.idioma != `Espanol');
	-- TODO: idioma = null?\end{lstlisting}

	% c)
	\item 
	Esta consulta no nos devuelve una unica fila, sino que para cada persona; nos devuelve el numero de idiomas que habla. AL estar ordenadas de mayor numero de idiomas hablados, a menor: obtendremos en primera posicion la persona que mas idiomas habla.
	\begin{lstlisting}[language=sql]
	select dni, sexo, edad, count(idioma) as lenguas_habladas
	from Habla
		 inner join Persona on dniPersona = dni
	group by dni
	order by lenguas_habladas desc;
	-- lenguas_habladas son filas unicas ya que idioma es unique.\end{lstlisting}
	
	\newpage
	En MySQL y PostgreSQL es sencillo poder limitar el numero de filas obtenidas en la anterior consulta, de la siguiente manera:
	\begin{lstlisting}[language=sql]
	select dni, sexo, edad, count(idioma) as lenguas_habladas
	from Habla
		 inner join Persona on dniPersona = dni
	group by dni
	order by lenguas_habladas desc
	limit 1;\end{lstlisting}
	
	Para Oracle SQL 12c R1 (12.1):
	\begin{lstlisting}[language=sql]
	select dni, sexo, edad, count(idioma) as lenguas_habladas
	from Habla
		 inner join Persona on dniPersona = dni
	group by dni
	order by lenguas_habladas desc
	fetch first 1 rows only;\end{lstlisting}
	
	Una manera mas trivial de conseguir el mismo resultado seria:
	\begin{lstlisting}[language=sql]
	select dni, sexo, edad, max(lenguas_habladas) as max_lh
	from (
		  select dni, sexo, edad, count(idioma) as lenguas_habladas
		  from Habla
			   inner join Persona on dniPersona = dni
		  group by dni
		  order by lenguas_habladas desc
		 )
	where max_lh = lenguas_habladas;\end{lstlisting}	
	\newpage

	% d)
	\item De manera trivial:
	\begin{lstlisting}[language=sql]
	select dni, sexo, edad, max(num_citas) as max_nc
	from (
		  select p2.*, count(*) as num_citas
		  from SolicitaCita
		  	   inner join Persona p1 on dniSolicitante = p1.dni
		  	   inner join Persona p2 on dniSolicitado = p2.dni
		  where p1.sexo != p2.sexo
		  group by p2.dni
		  order by num_citas desc
		 )
	where max_nc = num_citas;\end{lstlisting}
	
	Para MySQL y PostgreSQL:
	\begin{lstlisting}[language=sql]
	select p2.*, count(*) as num_citas
	from SolicitaCita
		 inner join Persona p1 on dniSolicitante = p1.dni
		 inner join Persona p2 on dniSolicitado = p2.dni
	where p1.sexo != p2.sexo
	group by p2.dni
	order by num_citas desc
	limit 1;\end{lstlisting}
	
	Para Oracle 12c R1 (12.1):
	\begin{lstlisting}[language=sql]
	select p2.*, count(*) as num_citas
	from SolicitaCita
	 	 inner join Persona p1 on dniSolicitante = p1.dni
		 inner join Persona p2 on dniSolicitado = p2.dni
	where p1.sexo != p2.sexo
	group by p2.dni
	order by num_citas desc
	fetch first 1 rows only;\end{lstlisting}
	\newpage
	
	% e)
	\item Recordamos que piden los idiomas hablados por el solicitante/solicitado pero que no han sido pedidos en la cita. Por lo que la consulta seria:
	\begin{lstlisting}[language=sql]
	select h1.idioma -- idiomas que habla el solicitante
	from SolicitaCita
		 inner join Habla h1 on dniSolicitante = dniPersona
	union -- une filas de manera vertical, sin duplicarlas.
	select h2.idioma -- idiomas que habla el solicitado
	from SolicitaCita
		 inner join Habla h2 on dniSolicitado = dniPersona
	minus
	select distinct idioma -- idiomas pedidos en las citas
	from SolicitaCita;\end{lstlisting}
	
	% f)
	\item 
	\begin{lstlisting}[language=sql]
	select distinct h1.*
	from SolicitaCita
		 inner join Habla h1 on dniSolicitante = h1.dniPersona
		 inner join Habla h2 on dniSolicitado = h2.dniPersona
		 inner join Persona on dniSolicitado = dni
	where sexo = `M' and edad < 25 
		  and h1.idioma = `Ingles' and h2.idioma = `Ingles';\end{lstlisting}
	
	% g)
	\item
	\begin{lstlisting}[language=sql]
	select dni, sexo, edad, count(idioma) as num_idiomas_hablados
	from ( 
		  select dni
		  from Persona
		  minus -- personas nunca solicitadas
		  select distinct dniSolicitado
		  from SolicitaCita
		 )
		 inner join Habla on dni = dniPersona;
		 inner join Persona p on dni = p.dni;\end{lstlisting}
\end{enumerate}